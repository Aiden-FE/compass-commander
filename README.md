# ä»0åˆ°1æ­å»ºç°ä»£åŒ–å‰ç«¯è„šæ‰‹æ¶

## ä¸ºä»€ä¹ˆéœ€è¦è„šæ‰‹æ¶

1. é‡å¤çš„äº‹æƒ…ç®€å•åŒ–
2. é¡¹ç›®åŸºç¡€æ ‡å‡†åŒ–
3. æ’ä»¶å¯æ’æ‹”
4. è§„èŒƒä¸€è‡´æ€§

## Roadmap

- [x] é¡¹ç›®ç¯å¢ƒæ­å»º(æ”¯æŒTypescript,è¾“å‡ºNode ESMåŒ…)
- [x] äº¤äº’å¼æ”¶é›†æ¨¡æ¿åˆ›å»ºé€‰é¡¹
- [ ] è„šæ‰‹æ¶è‡ªæ›´æ–°
- [ ] æ”¶é›†æ¨¡æ¿é€‰é¡¹,ç”Ÿæˆæˆ–æ‹‰å–ç›®æ ‡æ¨¡æ¿,æ›¿æ¢æ¨¡æ¿å˜é‡
- [ ] æ”¯æŒæ‹‰å–è‡ªå®šä¹‰æ¨¡æ¿
- [ ] æ”¯æŒå¯¹å†…ç½®æ¨¡æ¿è¿›è¡Œæ’ä»¶çš„æ’æ‹”
- [ ] æ”¯æŒç”Ÿæˆå¿«æ·ä»£ç ç‰‡æ®µ(å¯æŒ‡å®šè¿œç¨‹ä»£ç ç‰‡æ®µ),å¿«é€Ÿåˆ›å»ºæ ‡å‡†ä»£ç 

## é¡¹ç›®ç¯å¢ƒæ­å»º

æœ¬æ–‡å°†ä»¥ESMåŒ…ä¸ºäº§ç‰©æ­å»º,ä»¥é€‚åº”ç¤¾åŒº[CommonJS to ESM](https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c)çš„å˜åŒ–,åŒæ ·ä¹Ÿå¯èƒ½ä¼šé‡åˆ°node ESMç°ä»£åŒ–åº“çš„ä¸€äº›é—®é¢˜,åœ¨è¿™é‡Œäº†è§£å¹¶è§£å†³è¿™äº›é—®é¢˜.

Githubä»“åº“åœ°å€æŒç»­æ›´æ–°: [@compass-aiden/commander](https://github.com/Aiden-FE/compass-commander.git)

### åˆå§‹åŒ–é¡¹ç›®

> æœ¬æ–‡é»˜è®¤é‡‡ç”¨pnpmç®¡ç†ä¾èµ–,å®é™…æ“ä½œæ—¶å¯æ›¿æ¢ä¸ºnpm,yarnç­‰

`mkdir compass-commander` åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹
`npm init` åˆå§‹åŒ–é¡¹ç›®

`mkdir src` åˆ›å»ºæºä»£ç æ–‡ä»¶å¤¹
`touch src/main.ts` åˆ›å»ºå…¥å£æ–‡ä»¶

main.tsåˆå§‹å†…å®¹:
```typescript
export default () => {
  console.log('å…¥å£æ–‡ä»¶');
}
```

æ­¤æ—¶çš„ç›®å½•å¦‚ä¸‹:
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ package.json
â””â”€â”€ src
    â””â”€â”€ main.ts

### å»ºç«‹Rollupæ‰“åŒ…ç¯å¢ƒ

`touch .gitignore` åˆ›å»ºgitå¿½ç•¥é…ç½®,å…·ä½“å†…å®¹å› äººè€Œå¼‚,å¯ä»¥å…ˆåˆå§‹åŒ–ä¸ºå¦‚ä¸‹å†…å®¹:
```text
# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Runtime data
*.pid
*.seed
*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env

# next.js build output
.next

# OS X temporary files
.DS_Store

# Build files
dist
types

# lock
#pnpm-lock.yaml
```

`touch rollup.config.js` åˆ›å»ºæ‰“åŒ…å…¥å£æ–‡ä»¶

`pnpm add rollup rimraf @rollup/plugin-json rollup-plugin-ts rollup-plugin-terser rollup-plugin-cleanup rollup-plugin-summary @rollup/plugin-commonjs -D` å®‰è£…æ„å»ºæ‰€éœ€ä¾èµ–

`pnpm add typescript @zerollup/ts-transform-paths @types/node -D` å®‰è£…typescriptç¯å¢ƒä¾èµ–

`npx tsc --init` åˆå§‹åŒ–tsconfig.jsonæ–‡ä»¶,å¹¶å†…å®¹å¦‚ä¸‹æ‰€ç¤º,æ›´å…·ä½“çš„å¯ä»¥æ ¹æ®ä¸ªäººéœ€æ±‚è°ƒæ•´:
```json
{
    "compilerOptions": {
        "target": "ESNext",
        "lib": ["ESNext"],
        "module": "NodeNext",
        "moduleResolution": "node",
        "baseUrl": "./",
        "paths": {
            "~": [
                "src"
            ],
            "~/*": [
                "src/*"
            ]
        },
        "resolveJsonModule": true,
        "declaration": true,
        "outDir": "./dist",
        "declarationDir": "types",
        "esModuleInterop": true,
        "forceConsistentCasingInFileNames": true,
        "strict": true,
        "skipLibCheck": true,
        "plugins": [{ "transform": "@zerollup/ts-transform-paths" }]
    },
    "include": [
        "./src/**/*"
    ],
    "exclude": [
        "node_modules"
    ]
}
```

`touch index.js` åˆ›å»ºä¸€ä¸ªcommandå…¥å£æ–‡ä»¶,åˆå§‹å†…å®¹å¦‚ä¸‹:
```js
#!/usr/bin/env node

import main from './dist/main.js';

main();
```

æ¥ä¸‹æ¥å¯¹æˆ‘ä»¬çš„ package.json æ–‡ä»¶åšå‡ºä¸€äº›è°ƒæ•´,åˆ é™¤ main å­—æ®µå¹¶ä¿®æ”¹å¦‚ä¸‹å­—æ®µå†…å®¹
```json
{
    "type": "module", /* å£°æ˜è¿™æ˜¯ä¸€ä¸ªESMåº“ */
    "exports": "./dist/main.js",
    "types": "types/main.d.ts",
    "engines": {
        "node": ">=14.16" /* node å¯¹ esmçš„æ”¯æŒéœ€è¦å¤§äºè¿™ä¸ªç‰ˆæœ¬æ‰æ¯”è¾ƒç¨³å®š */
    },
    "files": [
        "dist",
        "types",
        "index.js"
    ], /* éœ€è¦è¢«å‘å¸ƒçš„æ–‡ä»¶ */
    "bin": {
        "compass": "index.js" // command å…¥å£
    },
    "publishConfig": {
        "registry": "https://registry.npmjs.org/"
    }, /* å‘å¸ƒé…ç½®,å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ */
    "scripts": {
        "start": "npm run dev",
        "dev": "rollup -w -c rollup.config.js",
        "build": "rollup -c rollup.config.js",
        "prepublish": "npm run clean",
        "clean": "rimraf dist && rimraf types"
    }
}
```

è¿˜éœ€è¦å¯¹rollup.config.jså†™å…¥å¦‚ä¸‹å†…å®¹:
```javascript
import json from '@rollup/plugin-json' // æ”¯æŒå¯¼å…¥json
import ts from "rollup-plugin-ts"; // æ”¯æŒts
import {builtinModules} from "module";
import { terser } from "rollup-plugin-terser"; // å‹ç¼©
import cleanup from "rollup-plugin-cleanup"; // æ¸…ç†æ³¨é‡Š
import summary from "rollup-plugin-summary"; // æ‰“åŒ…æ¦‚å†µ
import commonjs from "@rollup/plugin-commonjs"; // cjs to esm

const isProd = !process.env.ROLLUP_WATCH; // å¼€å¯watchæƒ…å†µå¯è®¤ä¸ºæ˜¯å¼€å‘ç¯å¢ƒ

/**
 * @description è·å–æ„å»ºæ’ä»¶
 * @param {('serve'|'nodeResolve'|'commonjs'|'compiler'|'terser'|'cleanup'|'summary')[]} disablePlugins å¾…ç¦ç”¨çš„æ’ä»¶
 * @return {(Plugin|false|{generateBundle: generateBundle, name: string})[]}
 */
function getPlugins(disablePlugins = []) {
  return [
    json(),
    ts(),
    !disablePlugins.includes('commonjs') && isProd && commonjs(),
    !disablePlugins.includes('terser') && isProd && terser(),
    !disablePlugins.includes('cleanup') && isProd && cleanup({ comments: 'none' }),
    !disablePlugins.includes('summary') && isProd && summary({
      totalLow: 1024 * 8,
      totalHigh: 1024 * 20,
      showBrotliSize: true,
      showGzippedSize: true,
      showMinifiedSize: true,
    }),
  ];
}

/**
 * @description è·å–è¦æ’é™¤çš„å¤–éƒ¨é€‰é¡¹
 * @param {string[]} additionalExternal
 * @return {string[]}
 */
function getExternal(additionalExternal = []) {
  return [...builtinModules].concat(additionalExternal || []);
}

/**
 * @description è·å–è¾“å‡ºé…ç½®é¡¹
 * @param options æ–‡æ¡£: https://www.rollupjs.com/guide/big-list-of-options
 * @return {Record<string, unknown>}
 */
function getOutput(
  options = { format: 'esm' }
) {
  return {
    dir: 'dist',
    chunkFileNames: 'bundle/chunk.[format].[hash].js',
    entryFileNames: '[name].js',
    sourcemap: !isProd,
    ...options,
  }
}

export default [
  {
    input: 'src/main.ts',
    output: getOutput(),
    external: getExternal(),
    plugins: getPlugins(),
    watch: {
      include: ['src/**'],
    },
  },
];
```

> å¦‚æœä½ ä»¬ä½¿ç”¨äº†@rollup/plugin-node-resolveçš„è¯,éœ€è¦æä¾›é€‰é¡¹{ exportConditions: ["node"] }ä»¥æ”¯æŒæ„å»º

ç°åœ¨æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹,å¦‚ä»Šå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œèµ·æ¥

`pnpm build` æ‰“åŒ…è¾“å‡ºäº§ç‰©

`npm link` æ·»åŠ åŒ…è½¯é“¾æ¥åˆ°å½“å‰ç¯å¢ƒä¸Šä¸‹æ–‡,ä»¥ä¾¿æœ¬åœ°è°ƒè¯•,åç»­å¯é€šè¿‡ `npm unlink @compass-aiden/commander -g` ç§»é™¤è½¯é“¾æ¥

`compass` æ‰§è¡Œå‘½ä»¤å·¥å…·,æŸ¥çœ‹æ˜¯å¦æ‰§è¡ŒæˆåŠŸ (**åç»­æœ¬æ–‡é»˜è®¤ä½ æ‰§è¡Œcompasså‰å·²å¯åŠ¨pnpm run dev å¼€å‘æ¨¡å¼æˆ–å·²æ‰§è¡Œpnpm buildæ„å»ºäº†äº§ç‰©**)

å¾ˆå¥½,åˆ°äº†è¿™é‡Œæˆ‘ä»¬çš„å‘½ä»¤è¡ŒæŒ‡ä»¤å·²ç»å¯ä»¥è¿è¡Œèµ·æ¥äº†,æ¥ä¸‹æ¥å°±æ˜¯å¡«å……å®ƒ!

## å»ºç«‹è„šæ‰‹æ¶å®ä¾‹

`pnpm add commander` å®‰è£… commander ä¾èµ–

ä¿®æ”¹src/main.tså†…å®¹å¦‚ä¸‹:
```typescript
import { Command } from 'commander';
import { version } from '../package.json';

export default () => {
  const program = new Command();
  
  program.version(`v${version}`, '-v, --version')
    .description('ä»0åˆ°1æ­å»ºå‰ç«¯è„šæ‰‹æ¶')
    .usage('<command> [option]')
    .parse(process.argv);
};
```

ç°åœ¨æˆ‘ä»¬æ¥è¯•ä¸€è¯•æ•ˆæœ

`compass -v` ç»ˆç«¯è¾“å‡ºè„šæ‰‹æ¶å½“å‰çš„ç‰ˆæœ¬ä¿¡æ¯

## åˆ›å»ºç¬¬ä¸€ä¸ªæ›´æ–°æ£€æŸ¥å‘½ä»¤

`mkdir src/commands` åˆ›å»ºå‘½ä»¤é›†æ–‡ä»¶å¤¹
`touch src/commands/update.cmd.ts` åˆ›å»ºæ›´æ–°å‘½ä»¤,åˆå§‹å†…å®¹å¦‚ä¸‹:
```typescript
import { Command } from 'commander';

export default (program: Command) => {
  program.command('update')
    .description('æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ–°ç‰ˆæœ¬å†…å®¹')
    .action(async () => {
      console.log('Run update command');
    });
};
```

`touch src/commands/index.ts` åˆ›å»ºç»Ÿä¸€å‡ºå£æ–‡ä»¶,å†…å®¹å¦‚ä¸‹:
```typescript
export { default as updateCommand } from './update.cmd'
```

æ›´æ–°src/main.tsæ–‡ä»¶å†…å®¹:
```typescript
import * as allCommands from './commands';

export default () => {
    // ...å…¶ä»–å†…å®¹
    Object.keys(allCommands)
        .forEach(key => ((allCommands as Record<string, Function>)[key])(program))
    // ...å…¶ä»–å†…å®¹
};
```

`compass update` çœ‹çœ‹ç»ˆç«¯ç°åœ¨æ˜¯å¦æˆåŠŸè¾“å‡ºäº†å†…å®¹

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ€è€ƒupdateè¦åšçš„ä¸€äº›äº‹æƒ…:

1. è·å–ä»“åº“ç‰ˆæœ¬åˆ—è¡¨
2. å–æœ€æ–°ç‰ˆæœ¬è·Ÿæœ¬åœ°ç‰ˆæœ¬æ¯”è¾ƒ
3. å¦‚æœå­˜åœ¨æ–°ç‰ˆæœ¬ç¡®è®¤æ˜¯å¦éœ€è¦æ›´æ–°
4. å¦‚æœéœ€è¦æ›´æ–°åˆ™é€‰æ‹©åŒ…ç®¡ç†å·¥å…·çš„åå¥½(npm,yarn,pnpm, é»˜è®¤é‡‡ç”¨npmæ›´æ–°)
5. æ›´æ–°è„šæ‰‹æ¶åŒ…

### æ”¯æŒæ‰“å°æ—¥å¿—åŠæä¾›loadingå±•ç¤ºæ”¯æŒ

ç”±äºè·å–ä»“åº“çš„ç‰ˆæœ¬å·åˆ—è¡¨æ˜¯ä¸€ä¸ªå¼‚æ­¥è¡Œä¸º,ç»ˆç«¯éœ€è¦ç»™å‡ºå‹å¥½æç¤º,æ‰“å°ç›¸å…³æ—¥å¿—,æˆ‘ä»¬éœ€è¦å…ˆå‡†å¤‡åŸºç¡€çš„æ—¥å¿—æœåŠ¡å’Œæä¾›loadingåŠŸèƒ½

`pnpm add chalk` ä¸ºäº†æ—¥å¿—çš„è¾“å‡ºèƒ½é€‚å½“ç¾è§‚ä¸€äº›,å®‰è£…æ­¤ä¾èµ–

`mkdir src/services` åˆ›å»ºæœåŠ¡é›†æ–‡ä»¶å¤¹
`touch src/services/logger.service.ts` åˆ›å»ºæ—¥å¿—æœåŠ¡æ–‡ä»¶,å¹¶åˆå§‹åŒ–å†…å®¹å¦‚ä¸‹,å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®è‡ªèº«å®é™…éœ€è¦åšå‡ºè°ƒæ•´:
```typescript
import chalk from 'chalk';

class LoggerService {
  private debugLevel = 1; // 0=debug;1=info;2=warn,success;3=error
  
  /**
   * @description è®¾ç½®debugçº§åˆ«,è®¾ç½®åé»˜è®¤æ—¥å¿—ä»…è¾“å‡ºå¤§äºç­‰äºå½“å‰çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯,é»˜è®¤çº§åˆ«åˆå§‹åŒ–ä¸º1
   * @param level 0=debug;1=info;2=warn,success;3=error
   */
  public setDebugLevel(level: 0 | 1 | 2 | 3) {
    this.debugLevel = level;
  }
  
  /**
   * @param msg æ¶ˆæ¯å†…å®¹
   * @param [print=true] æ˜¯å¦æ‰“å°æ—¥å¿—,ä¸ºå¦çš„çš„è¯åˆ™ä¸æ‰“å°æ—¥å¿—
   * @return {string} è¿”å›è¢«ç€è‰²åçš„æ–‡æœ¬æ¶ˆæ¯
   */
  public debug(msg: string, print = true) {
    const text = chalk.white(this.formatLog(msg, 'ğŸ”§'));
    if (print && this.debugLevel <= 0) {
      // eslint-disable-next-line no-console
      console.log(text);
    }
    return text;
  }
  
  public info(msg: string, print = true) {
    const text = chalk.cyan(this.formatLog(msg, 'ğŸ’¡'));
    if (print && this.debugLevel <= 1) {
      // eslint-disable-next-line no-console
      console.log(text);
    }
    return text;
  }
  
  public success(msg: string, print = true) {
    const text = chalk.green(this.formatLog(msg, 'âœ”ï¸'));
    if (print && this.debugLevel <= 2) {
      // eslint-disable-next-line no-console
      console.log(text);
    }
    return text;
  }
  
  public warning(msg: string, print = true) {
    const text = chalk.hex('#FFA500')(this.formatLog(msg, 'â€¼ï¸'));
    if (print && this.debugLevel <= 2) {
      // eslint-disable-next-line no-console
      console.log(text);
    }
    return text;
  }
  
  public error(msg: string, print = true) {
    const text = chalk.red(this.formatLog(msg, 'ğŸš«'));
    if (print && this.debugLevel <= 3) {
      // eslint-disable-next-line no-console
      console.log(text);
    }
    return text;
  }
  
  private formatLog(str: string, prefix?: string) {
    return `[${this.formatDate(new Date())}]:\t${prefix ? `${prefix}  ` : ''}${str}`;
  }
  
  private formatDate(date: Date, format = 'YYYY-MM-DD hh:mm:ss') {
    let str = format;
    const year = date.getFullYear().toString();
    const month = (date.getMonth() + 1).toString();
    const day = date.getDate().toString();
    const h = date.getHours().toString();
    const m = date.getMinutes().toString();
    const s = date.getSeconds().toString();
    str = str.replace('YYYY', year);
    str = str.replace('MM', month.length > 1 ? month : `0${month}`);
    str = str.replace('DD', day.length > 1 ? day : `0${day}`);
    str = str.replace('hh', h.length > 1 ? h : `0${h}`);
    str = str.replace('mm', m.length > 1 ? m : `0${m}`);
    str = str.replace('ss', s.length > 1 ? s : `0${s}`);
    return str;
  }
}

export default new LoggerService()
```
